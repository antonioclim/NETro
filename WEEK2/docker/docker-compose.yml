# ============================================================
# docker-compose.yml - Starterkit Săptămâna 2
# Rețele de calculatoare - ASE București, CSIE
# ============================================================
# Orchestrare containere pentru scenarii client-server TCP/UDP
# Revolvix&Hypotheticalandrei
# ============================================================

version: '3.8'

services:
  # ============================================================
  # SERVER - Rulează serverul TCP/UDP
  # ============================================================
  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: s2_server
    hostname: server
    networks:
      lab_network:
        ipv4_address: 172.28.0.10
    ports:
      - "8080:8080"   # TCP server
      - "9000:9000/udp"  # UDP server
    volumes:
      - ../seminar/python:/app/python:ro
      - ../pcap:/app/pcap
      - ../logs:/app/logs
    environment:
      - ROLE=server
      - TCP_PORT=8080
      - UDP_PORT=9000
    command: >
      bash -c "
        echo '=== Server container ready ===' &&
        echo 'TCP: python /app/python/exercises/ex_2_01_tcp.py server' &&
        echo 'UDP: python /app/python/exercises/ex_2_02_udp.py server' &&
        tail -f /dev/null
      "
    restart: unless-stopped

  # ============================================================
  # CLIENT - Rulează clienții TCP/UDP
  # ============================================================
  client:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: s2_client
    hostname: client
    networks:
      lab_network:
        ipv4_address: 172.28.0.20
    depends_on:
      - server
    volumes:
      - ../seminar/python:/app/python:ro
      - ../pcap:/app/pcap
      - ../logs:/app/logs
    environment:
      - ROLE=client
      - SERVER_HOST=172.28.0.10
      - TCP_PORT=8080
      - UDP_PORT=9000
    command: >
      bash -c "
        echo '=== Client container ready ===' &&
        echo 'TCP: python /app/python/exercises/ex_2_01_tcp.py client --host 172.28.0.10' &&
        echo 'UDP: python /app/python/exercises/ex_2_02_udp.py client --host 172.28.0.10' &&
        tail -f /dev/null
      "
    restart: unless-stopped

  # ============================================================
  # MONITOR - Captură pachete cu tshark
  # ============================================================
  monitor:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: s2_monitor
    hostname: monitor
    networks:
      lab_network:
        ipv4_address: 172.28.0.30
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ../pcap:/app/pcap
      - ../logs:/app/logs
    environment:
      - ROLE=monitor
    command: >
      bash -c "
        echo '=== Monitor container ready ===' &&
        echo 'Captură TCP: tshark -i any -f \"tcp port 8080\" -w /app/pcap/tcp_capture.pcap' &&
        echo 'Captură UDP: tshark -i any -f \"udp port 9000\" -w /app/pcap/udp_capture.pcap' &&
        tail -f /dev/null
      "
    restart: unless-stopped

# ============================================================
# REȚEA DEFINITĂ CUSTOM
# ============================================================
networks:
  lab_network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/24
          gateway: 172.28.0.1

# ============================================================
# VOLUME PERSISTENTE
# ============================================================
volumes:
  pcap_data:
    driver: local
  logs_data:
    driver: local
